<!DOCTYPE html>
<html style="background-color: {{ page_background_color or '#ffffff' }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1" />
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='./img/3D.ico') }}"/>
    <title>Crypto transfer with data wallet</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bootstrap.min.css') }}">

    <style>
      :root {
        --page-bg: {{ page_background_color or '#ffffff' }};
        --page-fg: {{ page_text_color or '#111827' }};
        --card-bg: #ffffff;
        --card-border: #e5e7eb;
        --muted: .7;
      }
      body { color: var(--page-fg); background: var(--page-bg); }
      .page-wrap { max-width: 1100px; }
      .muted { opacity: var(--muted); }
      .flashes { margin: 1rem 0; color: green; font-weight: bold; }
      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 6px 24px rgba(0,0,0,0.04);
      }
      .badge-soft {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #374151;
      }
      .code-area {
        width: 100%;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.9rem;
        line-height: 1.4;
        background: #f9fafb;
        color: #111827;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.75rem 0.9rem;
        resize: vertical;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .form-control, .custom-select { background: #ffffff; color: #111827; border: 1px solid #d1d5db; }
      .form-control:focus, .custom-select:focus { background: #ffffff; color: #111827; border-color: #9ca3af; box-shadow: none; }
      .custom-control-label { cursor: pointer; }
      .help { font-size: .85rem; opacity: .75; }
    </style>
  </head>
  <body>
    <div class="container page-wrap mt-4">
      <!-- Header -->
      <header class="text-center my-4">
        <h1 class="mt-3">Generate OIDC4VP crypto payment request</h1>
        <p class="lead muted">Choose a network, then a token available on that network. Set amount & recipient and launch.</p>
      </header>

      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="flashes">
            {% for message in messages %}
              <p>{{ message }}</p>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="row">
        <div class="col-lg-8 offset-2 mb-3">
          <div class="card p-3">
            <h5 class="mb-3">Transfer details</h5>

            <form method="post" action="/sandbox/verifier/crypto_transfer/build" id="transferForm">
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label class="small d-block mb-2">Protocol & Network</label>

                  <!-- OIDC4VP Draft switch (unchanged) -->
                  <div class="custom-control custom-switch mb-2">
                    <input type="checkbox" class="custom-control-input" id="above23" name="above_23" {% if above_23 %}checked{% endif %}>
                    <label class="custom-control-label" for="above23">
                      OIDC4VP Draft ≥ 23 <span class="muted">(off = below 23)</span>
                    </label>
                  </div>

                  <!-- NEW: Network picker -->
                  <label class="small mb-1">Network</label>
                  <select class="custom-select" id="networkSelect" required>
                    <optgroup label="Ethereum">
                      <option value="ethereum:mainnet">Ethereum — Mainnet</option>
                      <option value="ethereum:sepolia">Ethereum — Sepolia (testnet)</option>
                    </optgroup>
                    <optgroup label="Polygon">
                      <option value="polygon:mainnet">Polygon PoS — Mainnet</option>
                      <option value="polygon:amoy">Polygon PoS — Amoy (testnet)</option>
                    </optgroup>
                    <optgroup label="Etherlink (EVM L2)">
                      <option value="etherlink:mainnet">Etherlink — Mainnet</option>
                      <option value="etherlink:testnet">Etherlink — Testnet</option>
                    </optgroup>
                    <optgroup label="Tezos">
                      <option value="tezos:mainnet">Tezos — Mainnet</option>
                      <option value="tezos:ghostnet">Tezos — Ghostnet (testnet)</option>
                    </optgroup>
                  </select>

                  <!-- Hidden fields posted to backend -->
                  <input type="hidden" name="network_key" id="networkKey">
                  <input type="hidden" name="chain_type" id="chainType">
                  <input type="hidden" name="chain_id" id="chainIdInput">
                  <input type="hidden" name="token_kind" id="tokenKind">
                </div>

                <div class="form-group col-md-6">
                  <label class="small d-flex align-items-center">
                    Token
                    <span id="tokenHelp" class="help ml-2"></span>
                  </label>
                  <select class="custom-select" id="tokenSymbol" name="token_symbol" required>
                    <option value="" selected>— Choose —</option>
                    <!-- options populated dynamically -->
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label class="small">Amount (human, e.g., 5.25)</label>
                  <input type="text" class="form-control" name="human_amount" id="humanAmount" placeholder="0.0" required>
                </div>
                <div class="form-group col-md-6">
                  <label class="small">Recipient (address)</label>
                  <input type="text" class="form-control" name="recipient" id="recipient" placeholder="0x…" required>
                  <div class="help" id="recipientHelp">EVM: 0x… • Tezos: tz1… / KT1…</div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label class="small">Order ID (optional)</label>
                  <input type="text" class="form-control" name="order_id" placeholder="#12345">
                </div>
                <div class="form-group col-md-6">
                  <label class="small">UI Title (optional)</label>
                  <input type="text" class="form-control" name="ui_title" placeholder="Crypto payment">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label class="small">UI Subtitle (optional)</label>
                  <input type="text" class="form-control" name="ui_subtitle" placeholder="ERC-20 transfer demo">
                </div>
                <div class="form-group col-md-6">
                  <label class="small">UI Icon URI (optional)</label>
                  <input type="url" class="form-control" name="ui_icon_uri" placeholder="https://…">
                </div>
              </div>

              <div class="form-group">
                <label class="small">UI Purpose (optional)</label>
                <input type="text" class="form-control" name="ui_purpose" placeholder="Transfer 5 USDC to Merchant">
              </div>

              <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-outline-dark">Display QR code</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <footer class="text-center my-5 muted">
        <small>&copy; Web3 Digital Wallet, 2025</small>
      </footer>
    </div>

    <script src="{{ url_for('static', filename='jquery-3.5.1.slim.min.js') }}"></script>
    <script src="{{ url_for('static', filename='bs-init.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
    <script>
      // Registry: networks and tokens actually available on each.
      // NOTE: Native coins are shown but this demo backend only builds ERC-20 on EVM.
      const REGISTRY = {
        'ethereum:mainnet': {
          type: 'evm', chainId: 1,
          tokens: [
     //       { symbol: 'ETH',  label: 'ETH (native)', kind: 'native' },
            { symbol: 'USDC', label: 'USDC', kind: 'erc20' },
            { symbol: 'USDT', label: 'USDT', kind: 'erc20' },
            { symbol: 'TALAO', label: 'TALAO (mainnet only)', kind: 'erc20' }
          ]
        },
        'ethereum:sepolia': {
          type: 'evm', chainId: 11155111,
          tokens: [
     //       { symbol: 'ETH',  label: 'ETH (native)', kind: 'native' },
            { symbol: 'USDC', label: 'USDC (Circle test)', kind: 'erc20' },
             { symbol: 'EURC', label: 'EURC (Circle test)', kind: 'erc20' }
          ]
        },
        'polygon:mainnet': {
          type: 'evm', chainId: 137,
          tokens: [
      //      { symbol: 'MATIC', label: 'MATIC (native)', kind: 'native' },
            { symbol: 'USDC',  label: 'USDC (native)', kind: 'erc20' },
            { symbol: 'USDT',  label: 'USDT', kind: 'erc20' }
          ]
        },
        'polygon:amoy': {
          type: 'evm', chainId: 80002,
          tokens: [
   //         { symbol: 'MATIC', label: 'MATIC (native)', kind: 'native' },
            { symbol: 'USDC',  label: 'USDC (testnet)', kind: 'erc20' }
          ]
        },
        'etherlink:mainnet': {
          type: 'evm', chainId: 42793,
          tokens: [
            { symbol: 'XTZ', label: 'XTZ (native)', kind: 'native' }
          ]
        },
        'etherlink:testnet': {
          type: 'evm', chainId: 128123,
          tokens: [
            { symbol: 'XTZ', label: 'XTZ (native)', kind: 'native' }
          ]
        },
        'tezos:mainnet': {
          type: 'tezos', network: 'mainnet',
          tokens: [
            { symbol: 'XTZ', label: 'XTZ (native)', kind: 'native' }
          ]
        },
        'tezos:ghostnet': {
          type: 'tezos', network: 'ghostnet',
          tokens: [
            { symbol: 'XTZ', label: 'XTZ (native)', kind: 'native' }
          ]
        }
      };

      const networkSelect = document.getElementById('networkSelect');
      const tokenSelect   = document.getElementById('tokenSymbol');
      const tokenHelp     = document.getElementById('tokenHelp');
      const chainType     = document.getElementById('chainType');
      const chainIdInput  = document.getElementById('chainIdInput');
      const tokenKind     = document.getElementById('tokenKind');
      const networkKey    = document.getElementById('networkKey');
      const recipient     = document.getElementById('recipient');
      const recipientHelp = document.getElementById('recipientHelp');

      function refreshForNetwork() {
        const key = networkSelect.value;
        const cfg = REGISTRY[key];

        // Hidden fields for backend
        networkKey.value = key;
        chainType.value = cfg.type;
        chainIdInput.value = (cfg.type === 'evm') ? String(cfg.chainId) : '';

        // Recipient placeholder/help
        if (cfg.type === 'evm') {
          recipient.placeholder = '0x…';
          recipientHelp.textContent = 'EVM: 0x… • Tezos: tz1… / KT1…';
        } else {
          recipient.placeholder = 'tz1… / KT1…';
          recipientHelp.textContent = 'Tezos only: tz1… / tz2… / tz3… or KT1…';
        }

        // Rebuild token options
        tokenSelect.innerHTML = '<option value="">— Choose —</option>';
        cfg.tokens.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.symbol;
          opt.textContent = t.label || t.symbol;
          opt.dataset.kind = t.kind;
          tokenSelect.appendChild(opt);
        });

        tokenHelp.textContent = cfg.type === 'evm'
          ? '(ERC-20 supported in this demo; native shown for completeness)'
          : '(Tezos shown for completeness; this demo builds EVM ERC-20 only)';
        tokenKind.value = '';
      }

      function onTokenChange() {
        const selected = tokenSelect.options[tokenSelect.selectedIndex];
        tokenKind.value = selected?.dataset?.kind || '';
      }

      networkSelect.addEventListener('change', refreshForNetwork);
      tokenSelect.addEventListener('change', onTokenChange);
      // init defaults
      networkSelect.value = 'ethereum:mainnet';
      refreshForNetwork();
    </script>
  </body>
</html>
